<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
XML <br>
<div id="editorxml" class="default">
</div> <br><br>
JavaScript <br>
<div id="editorjs" class="default">
</div>
<p id="javascript-runtime-status" class="p-error">
</p> <br>
UI <br>
<div id="ui" class="ui-frame">
</div><br>

<hr>
Status: <p id="xml-status" class="p-ok">XML OK</p> <p id="js-status" class="p-ok">JavaScript OK</p>

<br>
<button id="submit" type="button" class="button-enabled">Submit</button>
</body>

<script src="../lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="../lib/VELVET/tools.js" type="text/javascript" charset="utf-8"></script>
<script src="../lib/VELVET/xmlvalidation.js" type="text/javascript" charset="utf-8"></script>
<script src="../lib/VELVET/xmlparser.js" type="text/javascript" charset="utf-8"></script>
<script src="../lib/VELVET/jsvalidation.js" type="text/javascript" charset="utf-8"></script>
<script src="../lib/VELVET/requirements.js" type="text/javascript" charset="utf-8"></script>
<script src="../lib/VELVET/esprima-master/esprima.js" type="text/javascript" charset="utf-8"></script>

<script>
	var ValidationStatus = { xml: true, js: true };
	var defaultXML = "\
<component>\n\n\
	<icon>http://satin.codemill.se:81/compicons/TriggerButton.png</icon>\n\n\
	<previewImage>http://satin.codemill.se:81/compicons/35454379-3815-4e95-ba2c-c7828b530044.png</previewImage>\n\n\
	<name>NewComponent</name>\n\n\
	<info><![CDATA[<!-- Write description here -->]]></info>\n\n\
	<config>\n\
	</config>\n\n\
	<requires>\n\
	</requires>\n\n\
	<provides>\n\
	</provides>\n\n\
	<interface>\n\
		<![CDATA[\n\
			<!-- Put HTML UI here -->\n\
		]]>\n\
	</interface>\n\n\
	<code_ext>\n\
		<!-- External Javascript components goes here -->\n\
		<!-- External components requires a suffix of .extern.js -->\n\
	</code_ext>\n\n\
	<apis>\n\
		<![CDATA[\n\
			<!-- External javascript files can be included here -->\n\
		]]>\n\
	</apis>\n\n\
</component>";

	var defaultJS = "\
function make_NewComponent (id, env) \n\
{\n\
	var button = document.getElementById(id);\n\
	button.setAttribute(\"value\", label);\n\
	button.onclick = function() { env.trigger() };\n\
}\n\
	";
	
	// get submit button
	var submit = document.getElementById("submit");
	
	// get ui div
	var ui = document.getElementById("ui");
	
	// get status labels
	var xml_status = document.getElementById("xml-status");
	var js_status = document.getElementById("js-status");
	
	// get javascript runtime label
	var js_runtime_status = document.getElementById("javascript-runtime-status");
	
	// setup XML editor
	var xmleditor = ace.edit("editorxml");
	xmleditor.setValue(defaultXML, -1);
    xmleditor.setTheme("ace/theme/monokai");
    xmleditor.getSession().setMode("ace/mode/xml");
	xmleditor.getSession().setUseWorker(false);
	var xmlsession = xmleditor.getSession();
	
	// setup JS editor
	var jseditor = ace.edit("editorjs");
	jseditor.setValue(defaultJS, -1);
    jseditor.setTheme("ace/theme/monokai");
    jseditor.getSession().setMode("ace/mode/javascript");
	jseditor.getSession().setUseWorker(false);
	var jssession = jseditor.getSession();
	
	// setup XML validation
	var xmlvalidationfunction = function() 
	{
		// setup requirements struct
		var requirements = new Requirements();
	
		xmlsession.removeListener('change', xmlvalidationfunction);
		xmlsession.clearAnnotations();
		jssession.clearAnnotations();
		ValidationStatus.xml = ValidateXML(xmlsession.getValue(), xmlsession, xmleditor, requirements);
		ui.innerHTML = requirements.interfaces;
		ValidationStatus.js = ValidateJS(jssession.getValue(), jssession, jseditor, requirements);
		xmlsession.on('change', xmlvalidationfunction);
		ValidateComponent(ValidationStatus, submit, xml_status, js_status);
		js_runtime_status.innerHTML = "";
	}
	xmlsession.on('change', xmlvalidationfunction);
	
	// setup JS validation
	var jsvalidationfunction = function()
	{
		// setup requirements struct
		var requirements = new Requirements();
	
		jssession.removeListener('change', jsvalidationfunction);
		jssession.clearAnnotations();
		ValidationStatus.xml = ValidateXML(xmlsession.getValue(), xmlsession, xmleditor, requirements);
		ValidationStatus.js = ValidateJS(jssession.getValue(), jssession, jseditor, requirements);
		jssession.on('change', jsvalidationfunction);
		ValidateComponent(ValidationStatus, submit, xml_status, js_status);
		js_runtime_status.innerHTML = "";
	}
	jssession.on('change', jsvalidationfunction);
	
		
	// handle general javascript errors
	window.onerror = function(msg, url, line, column, error)
	{
		var message = error.stack.replace("\n", "<br>");
		message = message.replace(/ /g, '\u00a0');
		js_runtime_status.innerHTML = message;
		VELVET_Error({row: line-1}, jseditor, "Runtime error caused by UI", null);
	}
	
</script>
</html>